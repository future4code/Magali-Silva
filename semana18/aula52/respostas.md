# Semana 18 - Aula 52: Serviços no Backend
### Exercício 1:
*Escreva uma função que receba um CEP, faça uma requisição para a url [https://viacep.com.br/ws/:cep/json/](https://viacep.com.br/ws/05424150/json/)  e retorne um objeto contendo: Logradouro, Bairro, Cidade, Estado*
```
export async function getAddressByCEP(CEP: number): Promise<Address> {
    const result = await axios.get(`${ADDRESS_URL}/${CEP}/json`)

    return {
        logradouro: result.data.logradouro,
        bairro: result.data.bairro,
        cidade: result.data.localidade,
        estado: result.data.uf
    }
}
```

### Exercício 2:
*No seu banco de dados, crie uma tabela para guardar as seguintes informações de endereço de um usuário: Logradouro, Número, Complemento (opcional), Bairro, Cidade, Estado*
~~~SQL
CREATE TABLE aula50_52_user_address(
    logradouro VARCHAR(255) NOT NULL,
    numero INT NOT NULL,
    complemento VARCHAR(255),
    bairro VARCHAR(255) NOT NULL,
    cidade VARCHAR(255) NOT NULL,
    estado VARCHAR(255) NOT NULL,
    user_id VARCHAR(255) PRIMARY KEY,
    FOREIGN KEY (user_id) REFERENCES aula50_users(id)
);

~~~

### Exercício 3:
*Refatore o endpoint de cadastro para ele receba, também, as informações básicas de endereço do usuário (CEP, número e complemento) e preencha todos os campos da tabela criada no exercício anterior.*

```
export const createUser = async (req: Request, res: Response) => {
    try {
        const { email, password, role, CEP, numero, complemento } = req.body
        let message = 'User created and token generated by jwt'

        if (!email || !password || !role || !CEP || !numero) {
            res.statusCode = 406
            message = '"email", "password", "role", "CEP" and "numero" are required'
            throw new Error(message)
        }

        if (!email.includes('@')) {
            message = 'missing "@" in the email'
            throw new Error(message)
        }

        if (password.length < 6) {
            message = 'Password must be at least 6 characters'
            throw new Error(message)
        }

        if (CEP.length < 8) {
            message = 'invalid CEP'
            throw new Error(message)
        }

        const id: string = generateId()
        const cypherPassword: string = await hash(password)

        const {logradouro, bairro, cidade, estado} = await getAddressByCEP(CEP)

        if (!logradouro || !bairro || !cidade || !estado) {
            throw new Error('invalid CEP')
        }

        await insertUser({
            id,
            email,
            password: cypherPassword,
            role
        })

        await insertAddress(
            id,
            numero,
            complemento,
            {
                logradouro,
                bairro,
                cidade,
                estado
            }  
        )

        const token: string = generateToken({
            id,
            role
        })

        res.status(200).send({
            message: message,
            token: token
        })
    } catch (error) {
        res.status(400).send({ message: error.sqlMessage || error.message })
    }
}
```